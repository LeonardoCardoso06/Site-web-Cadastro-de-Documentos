<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Cadastro de Documentos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="Pagina4_Arquivos.css" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="logo-placeholder">
          <img src="1 2.png" alt="Logo da Empresa" />
        </div>
        <h1>Cadastro de Documentos</h1>
      </header>

      <div class="painel-button-fixed">
        <button onclick="window.location.href='Painelusuario.html'">
          Painel do Usuário
        </button>

        <div id="alerta-substituicao" class="aviso-substituicao">
  ⚠️ Se você reenviar um documento já enviado, o anterior será substituído.
</div>

        <form id="documentForm" enctype="multipart/form-data">
          <div class="list">
            <div class="form-group">
  <label>RG/CNH:</label>
  <label class="file-upload-label" for="rgCnh">Selecionar arquivo</label>
  <input type="file" id="rgCnh" name="rgCnh" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="rgCnhName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Comprovante de Residência:</label>
  <label class="file-upload-label" for="comprovanteResidencia">Selecionar arquivo</label>
  <input type="file" id="comprovanteResidencia" name="comprovanteResidencia" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="comprovanteResidenciaName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Título de Eleitor:</label>
  <label class="file-upload-label" for="tituloEleitor">Selecionar arquivo</label>
  <input type="file" id="tituloEleitor" name="tituloEleitor" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="tituloEleitorName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Certidão de Alistamento Militar:</label>
  <label class="file-upload-label" for="certidaoMilitar">Selecionar arquivo</label>
  <input type="file" id="certidaoMilitar" name="certidaoMilitar" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="certidaoMilitarName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Exame Médico Admissional:</label>
  <label class="file-upload-label" for="exameMedico">Selecionar arquivo</label>
  <input type="file" id="exameMedico" name="exameMedico" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="exameMedicoName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Histórico Escolar:</label>
  <label class="file-upload-label" for="historicoEscolar">Selecionar arquivo</label>
  <input type="file" id="historicoEscolar" name="historicoEscolar" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="historicoEscolarName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>PIS (opcional):</label>
  <label class="file-upload-label" for="pis">Selecionar arquivo</label>
  <input type="file" id="pis" name="pis" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="pisName">Nenhum arquivo selecionado</div>
</div>

<div class="form-group">
  <label>Carteirinha OAB/CRC (opcional):</label>
  <label class="file-upload-label" for="carteirinha">Selecionar arquivo</label>
  <input type="file" id="carteirinha" name="carteirinha" accept=".pdf,.jpg,.jpeg,.png" />
  <div class="file-name" id="carteirinhaName">Nenhum arquivo selecionado</div>
</div>


          <div class="save-button">
            <button type="submit">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document
        .getElementById("documentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const token = localStorage.getItem("token");
          if (!token) {
            alert("Você precisa estar logado.");
            return (window.location.href = "Pagina1_Login.html");
          }

          const payload = JSON.parse(atob(token.split(".")[1]));
          const userId = payload.userId;

          const formData = new FormData();
          formData.append("userId", userId);

          const campos = [
            "rgCnh",
            "comprovanteResidencia",
            "tituloEleitor",
            "certidaoMilitar",
            "exameMedico",
            "historicoEscolar",
            "pis",
            "carteirinha",
          ];

          campos.forEach((campo) => {
            const input = document.getElementById(campo);
            if (input && input.files.length > 0) {
              formData.append(campo, input.files[0]);
            }
          });

          try {
            const response = await fetch(
              "http://localhost:3000/api/auth/upload-multiple",
              {
                method: "POST",
                body: formData,
              }
            );

            let result;
try {
  result = await response.json();
} catch (e) {
  const text = await response.text();
  alert("Erro ao enviar arquivos: " + text);
  return;
}


            if (response.ok) {
              alert("Documentos enviados com sucesso!");
              window.location.href = "Painelusuario.html";
            } else {
              alert("Erro: " + (result.error || result.details));
            }
          } catch (err) {
            alert("Erro ao enviar arquivos: " + err.message);
          }
        });

      function atualizarNomeArquivo(inputId, labelId) {
        const input = document.getElementById(inputId);
        const label = document.getElementById(labelId);

        input.addEventListener("change", function () {
          if (input.files.length > 0) {
            label.textContent = input.files[0].name;
          } else {
            label.textContent = "Nenhum arquivo selecionado";
          }
        });
      }

      atualizarNomeArquivo("rgCnh", "rgCnhName");
      atualizarNomeArquivo(
        "comprovanteResidencia",
        "comprovanteResidenciaName"
      );
      atualizarNomeArquivo("tituloEleitor", "tituloEleitorName");
      atualizarNomeArquivo("certidaoMilitar", "certidaoMilitarName");
      atualizarNomeArquivo("exameMedico", "exameMedicoName");
      atualizarNomeArquivo("historicoEscolar", "historicoEscolarName");
      atualizarNomeArquivo("pis", "pisName");
      atualizarNomeArquivo("carteirinha", "carteirinhaName");

      async function carregarDocumentosExistentes() {
  const userId = localStorage.getItem("userId"); // ou como você o recupera

  const response = await fetch(`http://localhost:3000/api/auth/admin/usuarios/${userId}`, {
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });

  const dados = await response.json();

  if (dados.arquivos && dados.arquivos.length > 0) {
    const tipos = dados.arquivos.map(a => a.document_type).join(", ");
    document.getElementById("documentos-existentes").innerText =
      `Documentos já enviados: ${tipos}`;
  }
}

carregarDocumentosExistentes()
    </script>
  </body>
</html>
