<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Painel do Usuário</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #d0f1ff, #f5faff);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 30px 10px;
      }

      .painel {
        background: white;
        width: 100%;
        max-width: 900px;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        animation: fadeIn 1s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h1,
      h2 {
        color: #007acc;
        text-align: center;
        margin-bottom: 20px;
      }

      .user-info p,
      .docs li {
        margin: 8px 0;
        padding: 8px 12px;
        background: #f2faff;
        border-left: 4px solid #007acc;
        border-radius: 8px;
      }

      .user-info strong {
        display: inline-block;
        min-width: 130px;
      }

      ul {
        list-style: none;
        padding: 0;
      }

      li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f9f9f9;
        margin-bottom: 8px;
        border-radius: 8px;
      }

      li a {
        text-decoration: none;
        color: #007bff;
        font-weight: 500;
      }

      li a:hover {
        text-decoration: underline;
      }

      .upload {
        margin-top: 30px;
        background: #eef9ff;
        padding: 20px;
        border-radius: 15px;
        animation: fadeIn 1.5s ease;
      }

      .upload form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      select,
      input[type="file"] {
        padding: 10px;
        font-size: 1rem;
        border-radius: 10px;
        border: 1px solid #ccc;
      }

      button {
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #00aeff, #0073e6);
        color: white;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
      }

      button:hover {
        background: linear-gradient(45deg, #0073e6, #005bb5);
        transform: scale(1.03);
      }

      .logout {
        text-align: center;
        margin-top: 30px;
      }

      .delete-btn {
        background: transparent;
        color: #e74c3c;
        font-weight: bold;
        cursor: pointer;
        border: none;
        font-size: 0.95rem;
      }

      .delete-btn:hover {
        text-decoration: underline;
      }

      .divider {
        margin: 30px 0;
        border-top: 1px dashed #ccc;
      }
    </style>
  </head>
  <body>
    <div class="painel">
      <h1>Bem-vindo, <span id="nomeUsuario">Usuário</span></h1>
      <div class="user-info">
        <h2>Seus dados</h2>
        <p><strong>Email:</strong> <span id="email"></span></p>
        <p><strong>Telefone:</strong> <span id="phone"></span></p>
        <p><strong>Gênero:</strong> <span id="gender"></span></p>
        <p><strong>CPF:</strong> <span id="cpf"></span></p>
        <p><strong>Endereço:</strong> <span id="address"></span></p>
        <p><strong>Vale Transporte:</strong> <span id="vt"></span></p>
        <p><strong>Deficiência:</strong> <span id="deficiencia"></span></p>
        <p><strong>Observações:</strong> <span id="obs"></span></p>
      </div>

      <div class="divider"></div>

      <div class="docs">
        <h2>Seus Documentos</h2>
        <ul id="listaDocs">
          <li>Carregando documentos...</li>
        </ul>
      </div>

      <div class="logout">
        <button onclick="logout()">Sair</button>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Você precisa estar logado para acessar esta página.");
        window.location.href = "Pagina1_Login.html";
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "Pagina1_Login.html";
      }

      function formatarTipoDocumento(tipo) {
        const nomesFormatados = {
          rgCnh: "RG / CNH",
          comprovanteResidencia: "Comprovante de Residência",
          tituloEleitor: "Título de Eleitor",
          certidaoMilitar: "Certidão Militar",
          exameMedico: "Exame Médico",
          historicoEscolar: "Histórico Escolar",
          pis: "PIS",
          carteirinha: "Carteirinha",
          cpf: "CPF",
          rg: "RG",
          outro: "Outro",
        };
        return nomesFormatados[tipo] || tipo;
      }

      function carregarUsuario() {
        fetch("http://localhost:3000/api/auth/me", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => {
            if (!res.ok) throw new Error("Não autorizado");
            return res.json();
          })
          .then((user) => {
            document.getElementById("nomeUsuario").textContent =
              user.firstname + " " + user.lastname;
            document.getElementById("email").textContent = user.email || "-";
            document.getElementById("phone").textContent = user.phone || "-";
            document.getElementById("gender").textContent = user.gender || "-";
            document.getElementById("cpf").textContent = user.cpf || "-";
            document.getElementById("address").textContent =
              user.address || "-";
            document.getElementById("vt").textContent = user.vale_transporte
              ? "Sim"
              : "Não";
            document.getElementById("deficiencia").textContent =
              user.possui_deficiencia ? "Sim" : "Não";
            document.getElementById("obs").textContent =
              user.observacoes || "-";

            const lista = document.getElementById("listaDocs");
            lista.innerHTML = "";

            if (user.arquivos && user.arquivos.length > 0) {
              user.arquivos.forEach((doc) => {
                const url = `http://localhost:3000/${doc.path.replace(
                  /\\/g,
                  "/"
                )}`;
                const item = document.createElement("li");

                item.innerHTML = `
                  <span>
                    <a href="${url}" target="_blank">${formatarTipoDocumento(
                  doc.document_type
                )}</a>
                  </span>
                  <input type="file" id="upload-${
                    doc.document_type
                  }" style="display:none" accept=".pdf,.jpg,.jpeg,.png"
                    onchange="substituirDocumento('${
                      doc.document_type
                    }', this.files[0])" />
                  <button class="delete-btn" onclick="document.getElementById('upload-${
                    doc.document_type
                  }').click()">Substituir</button>
                `;
                lista.appendChild(item);
              });
            } else {
              lista.innerHTML = "<li>Nenhum documento enviado.</li>";
            }
          })
          .catch((err) => {
            alert("Erro ao carregar dados. Faça login novamente.");
            logout();
          });
      }

      function substituirDocumento(tipo, file) {
        if (!file) return;

        const userId = JSON.parse(atob(token.split(".")[1])).userId;
        const formData = new FormData();
        formData.append("userId", userId);
        formData.append(tipo, file);

        fetch("http://localhost:3000/api/auth/upload-multiple", {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
          body: formData,
        })
          .then((res) => res.json())
          .then((result) => {
            if (result.message) {
              alert("Documento substituído com sucesso!");
              carregarUsuario();
            } else {
              alert("Erro ao substituir: " + (result.error || result.details));
            }
          })
          .catch((err) => {
            alert("Erro ao enviar: " + err.message);
          });
      }

      carregarUsuario();
    </script>
  </body>
</html>
