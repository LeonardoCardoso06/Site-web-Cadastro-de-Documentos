<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo</title>
    <link rel="stylesheet" href="PaginaAdmin.css" />
    <style></style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Painel Administrativo</h1>
        <div class="painel-button-container">
          <button class="painel-button" onclick="carregarUsuarios()">
            üîÑ Recarregar Lista
          </button>
          <button class="painel-button" onclick="toggleModoGerenciar()">
            üë• Gerenciar Usu√°rios
          </button>
        </div>
      </div>

      <input
        type="text"
        id="search"
        placeholder="Pesquisar por nome..."
        class="search-input"
        onkeyup="filtrarUsuarios()"
      />

      <table id="usuariosTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>CPF</th>
            <th>A√ß√µes</th>
            <th class="delete-column">Excluir</th>
          </tr>
        </thead>
        <tbody id="usuariosBody"></tbody>
      </table>
    </div>

    <!-- Modal Informa√ß√µes -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModal('infoModal')">&times;</span>
        <h3>Informa√ß√µes de <span id="infoNome"></span></h3>
        <div id="infoContainer" class="info-grid"></div>
      </div>
    </div>

    <!-- Modal Documentos -->
    <!-- Modal Visualiza√ß√£o Individual -->
    <div id="visualizarModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModal('visualizarModal')"
          >&times;</span
        >
        <h3 id="visualizarTitulo"></h3>
        <div id="visualizarConteudo" style="text-align: center"></div>
      </div>
    </div>

    <div id="documentosModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModal('documentosModal')"
          >&times;</span
        >
        <h3>Documentos de <span id="modalNome"></span></h3>
        <div id="documentosContainer"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      let modoGerenciar = false;

      function toggleModoGerenciar() {
        modoGerenciar = !modoGerenciar;

        document.querySelectorAll("th.delete-column").forEach((el) => {
          el.style.display = modoGerenciar ? "table-cell" : "none";
        });

        carregarUsuarios();
      }

      function visualizarDocumento(url, titulo) {
        const conteudo = document.getElementById("visualizarConteudo");
        const ext = url.split(".").pop().toLowerCase();

        let elemento;

        if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
          elemento = `<img src="${url}" style="max-width:90%; max-height:80vh; border-radius:10px;" />`;
        } else if (ext === "pdf") {
          elemento = `<embed src="${url}" type="application/pdf" width="100%" height="600px" />`;
        } else {
          elemento = `<p>Visualiza√ß√£o n√£o suportada para este tipo de arquivo.</p>`;
        }

        document.getElementById("visualizarTitulo").textContent = titulo;
        conteudo.innerHTML = elemento;
        document.getElementById("visualizarModal").style.display = "block";
      }

      async function carregarUsuarios() {
        try {
          const response = await fetch(
            "http://localhost:3000/api/auth/admin/usuarios",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const usuarios = await response.json();
          const tbody = document.getElementById("usuariosBody");
          tbody.innerHTML = "";
          usuarios.forEach(renderUsuarioRow);
        } catch (error) {
          console.error("Erro ao buscar usu√°rios:", error);
        }
      }

      function renderUsuarioRow(user) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td>${user.id}</td>
    <td>${user.firstname} ${user.lastname}</td>
    <td>${user.cpf || "-"}</td>
    <td>
      <div class="action-buttons">
        <button class="painel-button" onclick='abrirModalInfo(${JSON.stringify(
          user
        )})'>üë§ Informa√ß√µes</button>
        <button class="painel-button" onclick='abrirModalDocumentos(${JSON.stringify(
          user
        )})'>üìÅ Documentos</button>
      </div>
    </td>
 <td class="delete-column">
  <button class="delete-btn" onclick="excluirUsuario(${user.id})">üóëÔ∏è</button>
</td>
  `;

        const deleteCol = tr.querySelector(".delete-column");
        deleteCol.style.display = modoGerenciar ? "table-cell" : "none";

        document.getElementById("usuariosBody").appendChild(tr);
      }

      async function excluirUsuario(userId) {
        if (!confirm("Tem certeza que deseja excluir este usu√°rio?")) return;
        try {
          const response = await fetch(
            `http://localhost:3000/api/auth/admin/usuarios/${userId}`,
            {
              method: "DELETE",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (response.ok) {
            alert("Usu√°rio exclu√≠do com sucesso.");
            carregarUsuarios();
          } else {
            alert("Erro ao excluir usu√°rio.");
          }
        } catch (error) {
          console.error("Erro ao excluir usu√°rio:", error);
        }
      }

      async function abrirModalInfo(user) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/auth/admin/usuarios/${user.id}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const dados = await response.json();

          document.getElementById(
            "infoNome"
          ).textContent = `${dados.firstname} ${dados.lastname}`;
          const infoContainer = document.getElementById("infoContainer");

          infoContainer.innerHTML = `
      <p><strong>Email:</strong> ${dados.email || "-"}</p>
      <p><strong>Telefone:</strong> ${dados.phone || "-"}</p>
      <p><strong>G√™nero:</strong> ${dados.gender || "-"}</p>
      <p><strong>CPF:</strong> ${dados.cpf || "-"}</p>
      <p><strong>Endere√ßo:</strong> ${dados.address || "-"}</p>
      <p><strong>Data de Nascimento:</strong> ${dados.birthdate || "-"}</p>
      <p><strong>VT:</strong> ${dados.vale_transporte ? "Sim" : "N√£o"}</p>
      <p><strong>N¬∫ Trem:</strong> ${dados.numero_trem || "-"}</p>
      <p><strong>N¬∫ √înibus:</strong> ${dados.numero_onibus || "-"}</p>
      <p><strong>Defici√™ncia:</strong> ${
        dados.possui_deficiencia ? "Sim" : "N√£o"
      }</p>
      <p><strong>Observa√ß√µes:</strong> ${dados.observacoes || "-"}</p>
    `;

          document.getElementById("infoModal").style.display = "block";
        } catch (error) {
          alert("Erro ao carregar informa√ß√µes do usu√°rio.");
          console.error(error);
        }
      }

      async function abrirModalDocumentos(user) {
        try {
          const response = await fetch(
            `http://localhost:3000/api/auth/admin/usuarios/${user.id}`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const dados = await response.json();

          document.getElementById(
            "modalNome"
          ).textContent = `${dados.firstname} ${dados.lastname}`;
          const container = document.getElementById("documentosContainer");
          container.innerHTML = "";

          if (!dados.arquivos || dados.arquivos.length === 0) {
            container.innerHTML = "<p>Nenhum documento encontrado.</p>";
          } else {
            dados.arquivos.forEach((doc) => {
              const div = document.createElement("div");
              div.className = "documento-item";

              const url = `http://localhost:3000/${doc.path.replace(
                /\\/g,
                "/"
              )}`;
              const fileOnly = doc.path.split("/").pop();
              const downloadUrl = `http://localhost:3000/api/auth/download/${encodeURIComponent(
                fileOnly
              )}`;
              const nomeAmigavel = `${doc.document_type.replace(
                /[^a-z0-9]/gi,
                "_"
              )}${doc.filename.slice(doc.filename.lastIndexOf("."))}`;

              div.innerHTML = `
          <p><strong>${doc.document_type}</strong></p>
          <button class="painel-button" onclick="visualizarDocumento('${url}', '${doc.document_type}')">üëÅÔ∏è Visualizar</button>
          <button class="painel-button" onclick="baixarDocumento('${downloadUrl}', '${nomeAmigavel}')">‚¨áÔ∏è Download</button>
        `;

              container.appendChild(div);
            });
          }

          document.getElementById("documentosModal").style.display = "block";
        } catch (error) {
          alert("Erro ao carregar documentos do usu√°rio.");
          console.error(error);
        }
      }

      function fecharModal(id) {
        document.getElementById(id).style.display = "none";
      }

      function filtrarUsuarios() {
        const termo = document.getElementById("search").value.toLowerCase();
        const linhas = document.querySelectorAll("#usuariosBody tr");
        linhas.forEach((linha) => {
          const nome = linha.cells[1].textContent.toLowerCase();
          linha.style.display = nome.includes(termo) ? "" : "none";
        });
      }

      function baixarDocumento(url, nomeDesejado) {
        fetch(url, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => {
            if (!res.ok) throw new Error("Erro ao baixar documento");
            return res.blob();
          })
          .then((blob) => {
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = nomeDesejado;
            document.body.appendChild(link);
            link.click();
            link.remove();
          })
          .catch((err) => {
            alert("Erro ao baixar documento.");
            console.error(err);
          });
      }

      // Inicializa tabela ao carregar a p√°gina
      carregarUsuarios();
    </script>
  </body>
</html>
